name: Publish npm package

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  id-token: write # for oidc trusted publishers

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if changeset is in prerelease mode
        id: check-in-pre
        run: echo "pre=$(test -r .changeset/pre.json; echo $?)"  >> "$GITHUB_OUTPUT"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
          scope: '@ops-frontier'

      - name: Upgrade npm CLI for Trusted Publishing
        run: npm install -g npm@latest

      - name: Publish npm package
        run: |
          # 1. pre.json ã®æœ‰ç„¡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ•°ã«æ ¼ç´
          # 0: å­˜åœ¨ã™ã‚‹ (RCãƒ¢ãƒ¼ãƒ‰) / 1: å­˜åœ¨ã—ãªã„ (æ­£è¦ãƒ¢ãƒ¼ãƒ‰)
          PRE_EXISTS=$(test -r .changeset/pre.json; echo $?)
          
          # 2. pre.json ã®å­˜åœ¨ã«å¿œã˜ã¦ã€--tag ã®å€¤ã‚’æ±ºå®š
          # å­˜åœ¨ã™ã‚‹å ´åˆ (0): --tag rc ã‚’ä½¿ç”¨
          # å­˜åœ¨ã—ãªã„å ´åˆ (1): ä½•ã‚‚è¨­å®šã—ãªã„ï¼ˆnpmãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® --tag latest ã‚’ä½¿ç”¨ï¼‰
          if [ "$PRE_EXISTS" -eq 0 ]; then
            TAG_OPTION="--tag rc"
            echo "Pre-release mode detected. Publishing with tag: rc"
          else
            TAG_OPTION=""
            echo "Stable release mode detected. Publishing with tag: latest (default)"
          fi
          
          # 3. æ±ºå®šã—ãŸå¤‰æ•°ã‚’ä½¿ç”¨ã—ã¦ npm publish ã‚’å®Ÿè¡Œ
          npm install --no-audit --no-fund --ci
          
          # ğŸ’¡ TAG_OPTION ã‚’ã‚³ãƒãƒ³ãƒ‰ã«å‹•çš„ã«åŸ‹ã‚è¾¼ã‚€
          npm publish $TAG_OPTION --workspace=packages/docusaurus
          